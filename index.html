import React, { useState, useEffect } from 'react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, addDoc, serverTimestamp } from "firebase/firestore";
import { 
  BookOpen, Star, Trophy, CheckCircle, XCircle, 
  Settings, RefreshCcw, Brain, Leaf, Wifi, WifiOff, Globe, AlertCircle, Loader2, Sparkles
} from 'lucide-react';

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyAdfK9CAYMyjLsXmYHJJvNdIZb0gKaOosQ",
  authDomain: "soal-belajar-anak-sd.firebaseapp.com",
  projectId: "soal-belajar-anak-sd",
  storageBucket: "soal-belajar-anak-sd.firebasestorage.app",
  messagingSenderId: "620007293250",
  appId: "1:620007293250:web:cb509a56984b9e212b08db",
  measurementId: "G-0SDCDR5B5H"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- GEMINI AI CONFIG ---
// API Key akan disediakan oleh environment runtime secara otomatis
const apiKey = ""; 

// --- DATA KURIKULUM & GENERATOR LOKAL (FALLBACK) ---

const SUBJECTS = {
  1: ["Matematika", "B. Indonesia", "Pancasila", "B. Inggris"],
  2: ["Matematika", "B. Indonesia", "Pancasila", "B. Inggris"],
  3: ["Matematika", "Sains (IPAS)", "B. Inggris", "Pancasila"],
  4: ["Matematika", "Sains (IPAS)", "B. Inggris", "Pancasila"],
  5: ["Matematika", "Sains (IPAS)", "B. Inggris", "Sejarah"],
  6: ["Matematika", "Sains (IPAS)", "B. Inggris", "Sejarah"]
};

// --- HELPER RANDOM ---
const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
const shuffleArray = (array) => array.sort(() => Math.random() - 0.5);

// --- 1. GENERATOR MATEMATIKA (LOKAL) ---
const generateMathQuestion = (grade) => {
  let q, a;
  const type = getRandomInt(1, grade <= 2 ? 2 : 4); 

  let num1, num2;
  if (grade <= 2) { num1 = getRandomInt(1, 20); num2 = getRandomInt(1, 20); }
  else if (grade <= 4) { num1 = getRandomInt(10, 100); num2 = getRandomInt(5, 50); }
  else { num1 = getRandomInt(50, 500); num2 = getRandomInt(10, 100); }

  if (type === 1) { q = `${num1} + ${num2} = ...`; a = num1 + num2; }
  else if (type === 2) { if (num1 < num2) [num1, num2] = [num2, num1]; q = `${num1} - ${num2} = ...`; a = num1 - num2; }
  else if (type === 3) { num1 = getRandomInt(2, 12); num2 = getRandomInt(2, 12); q = `${num1} x ${num2} = ...`; a = num1 * num2; }
  else { num2 = getRandomInt(2, 10); a = getRandomInt(2, 12); num1 = num2 * a; q = `${num1} : ${num2} = ...`; }

  let opts = new Set([a]);
  while (opts.size < 4) {
    let wrong = a + getRandomInt(-10, 10);
    if (wrong >= 0 && wrong !== a) opts.add(wrong);
  }
  return { question: q, options: shuffleArray(Array.from(opts).map(String)), answer: String(a), type: "Matematika" };
};

// --- 2. GENERATOR BAHASA INGGRIS (LOKAL) ---
const VOCAB_DATA = {
  colors: [
    { en: "Red", id: "Merah" }, { en: "Blue", id: "Biru" }, { en: "Green", id: "Hijau" }, 
    { en: "Yellow", id: "Kuning" }, { en: "Black", id: "Hitam" }, { en: "White", id: "Putih" }
  ],
  animals: [
    { en: "Cat", id: "Kucing" }, { en: "Dog", id: "Anjing" }, { en: "Elephant", id: "Gajah" }, 
    { en: "Snake", id: "Ular" }, { en: "Bird", id: "Burung" }, { en: "Fish", id: "Ikan" },
    { en: "Lion", id: "Singa" }, { en: "Tiger", id: "Harimau" }, { en: "Monkey", id: "Monyet" }
  ],
  family: [
    { en: "Father", id: "Ayah" }, { en: "Mother", id: "Ibu" }, { en: "Brother", id: "Saudara Laki-laki" },
    { en: "Sister", id: "Saudara Perempuan" }, { en: "Grandmother", id: "Nenek" }, { en: "Grandfather", id: "Kakek" }
  ],
  fruits: [
    { en: "Apple", id: "Apel" }, { en: "Banana", id: "Pisang" }, { en: "Grape", id: "Anggur" },
    { en: "Orange", id: "Jeruk" }, { en: "Watermelon", id: "Semangka" }
  ]
};

const generateEnglishQuestion = (grade) => {
  let categories = ['colors', 'animals', 'fruits'];
  if (grade >= 3) categories.push('family');
  
  const cat = getRandomItem(categories);
  const item = getRandomItem(VOCAB_DATA[cat]);
  const isEnToId = Math.random() > 0.5; 

  let q, a;
  if (isEnToId) {
    q = `Bahasa Indonesia dari "${item.en}" adalah...`;
    a = item.id;
  } else {
    q = `English of "${item.id}" is...`;
    a = item.en;
  }

  let opts = new Set([a]);
  const pool = VOCAB_DATA[cat];
  while (opts.size < 4) {
    const wrong = getRandomItem(pool);
    const wrongAnswer = isEnToId ? wrong.id : wrong.en;
    if (wrongAnswer !== a) opts.add(wrongAnswer);
  }

  return { question: q, options: shuffleArray(Array.from(opts)), answer: a, type: "B. Inggris" };
};

// --- 3. GENERATOR SAINS / IPAS (LOKAL) ---
const SCIENCE_DATA = {
  food: [
    { type: "Herbivora", examples: ["Sapi", "Kambing", "Kuda", "Kelinci", "Gajah"] },
    { type: "Karnivora", examples: ["Singa", "Harimau", "Elang", "Hiu", "Serigala"] },
    { type: "Omnivora", examples: ["Ayam", "Tikus", "Bebek", "Beruang"] }
  ],
  physics: [
    { state: "Padat", examples: ["Batu", "Kayu", "Besi", "Meja"] },
    { state: "Cair", examples: ["Air", "Minyak", "Sirup", "Susu"] },
    { state: "Gas", examples: ["Oksigen", "Uap Air", "Asap", "Udara"] }
  ],
  biology: [
    { part: "Akar", func: "Menyerap air" },
    { part: "Daun", func: "Fotosintesis" },
    { part: "Bunga", func: "Alat perkembangbiakan" },
    { part: "Batang", func: "Menopang tumbuhan" }
  ]
};

const generateScienceQuestion = (grade) => {
  const types = ["food", "physics"];
  if (grade >= 4) types.push("biology");
  const topic = getRandomItem(types);

  let q, a, opts;

  if (topic === "food" || topic === "physics") {
    const data = SCIENCE_DATA[topic];
    const correctCat = getRandomItem(data);
    const correctExample = getRandomItem(correctCat.examples);
    
    if (Math.random() > 0.5) {
      q = `${correctExample} adalah contoh dari benda/hewan...`;
      a = topic === "food" ? correctCat.type : correctCat.state;
      opts = data.map(d => topic === "food" ? d.type : d.state);
      if (opts.length < 4) opts.push("Tidak ada yang benar");
    } else {
      q = `Berikut ini yang termasuk ${topic === "food" ? correctCat.type : "benda " + correctCat.state} adalah...`;
      a = correctExample;
      opts = [a];
      const otherCats = data.filter(d => d !== correctCat);
      while (opts.length < 4) {
        const wrongCat = getRandomItem(otherCats);
        const wrongEx = getRandomItem(wrongCat.examples);
        if (!opts.includes(wrongEx)) opts.push(wrongEx);
      }
    }
  } else {
    const item = getRandomItem(SCIENCE_DATA.biology);
    q = `Fungsi dari ${item.part} pada tumbuhan adalah...`;
    a = item.func;
    opts = SCIENCE_DATA.biology.map(b => b.func);
  }

  return { question: q, options: shuffleArray(opts), answer: a, type: "Sains (IPAS)" };
};

// --- BANK SOAL STATIS (FALLBACK TERAKHIR) ---
const STATIC_POOL = [
  { subject: "Pancasila", q: "Dasar negara Indonesia adalah...", a: "Pancasila", o: ["UUD 1945", "Pancasila", "Tap MPR", "Perpres"] },
  { subject: "Pancasila", q: "Sila pertama dilambangkan dengan...", a: "Bintang", o: ["Bintang", "Rantai", "Pohon Beringin", "Padi Kapas"] },
  { subject: "Sejarah", q: "Presiden pertama Indonesia adalah...", a: "Soekarno", o: ["Soeharto", "Habibie", "Soekarno", "Hatta"] },
  { subject: "B. Indonesia", q: "Lawan kata 'Panjang' adalah...", a: "Pendek", o: ["Tinggi", "Luas", "Pendek", "Besar"] }
];

// --- FUNGSI AI GENERATOR (GEMINI) ---
const generateQuestionsWithGemini = async (grade, subject, count) => {
  const prompt = `Buatkan ${count} soal pilihan ganda untuk siswa SD Kelas ${grade} mata pelajaran ${subject} di Indonesia. 
  Soal harus variatif, edukatif, dan sesuai Kurikulum Merdeka.
  Jangan berikan penjelasan tambahan, hanya JSON murni.
  
  Format JSON yang WAJIB diikuti:
  [
    {
      "question": "Pertanyaan disini?",
      "options": ["Pilihan A", "Pilihan B", "Pilihan C", "Pilihan D"],
      "answer": "Jawaban Benar (harus sama persis dengan salah satu opsi)",
      "type": "${subject}"
    }
  ]
  `;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          // Mengaktifkan Google Search agar data up-to-date
          tools: [{ google_search: {} }],
          generationConfig: {
            responseMimeType: "application/json"
          }
        }),
      }
    );

    if (!response.ok) throw new Error("AI Busy");
    
    const result = await response.json();
    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
    
    if (!text) throw new Error("No data");
    
    // Parsing JSON dari AI
    let questions = JSON.parse(text);
    
    // Validasi sederhana
    if (!Array.isArray(questions) || questions.length === 0) throw new Error("Invalid Format");
    
    return questions;

  } catch (error) {
    console.error("AI Generation Error:", error);
    return null; // Return null to trigger fallback
  }
};


// --- MAIN APP ---
export default function App() {
  const [user, setUser] = useState(null);
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  
  // Setup State
  const [grade, setGrade] = useState(1);
  const [subject, setSubject] = useState("Matematika");
  const [qCount, setQCount] = useState(10);
  
  // Notification & Loading
  const [notification, setNotification] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [usedAI, setUsedAI] = useState(false); // Flag untuk tahu apakah pakai AI atau Fallback
  
  // Game State
  const [view, setView] = useState("setup");
  const [questions, setQuestions] = useState([]);
  const [currentIdx, setCurrentIdx] = useState(0);
  const [score, setScore] = useState(0);
  const [selectedOpt, setSelectedOpt] = useState(null);
  const [isCorrect, setIsCorrect] = useState(null);

  useEffect(() => {
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, setUser);

    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  useEffect(() => {
    setSubject(SUBJECTS[grade][0]);
  }, [grade]);

  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  };

  // --- START QUIZ LOGIC (UPDATED WITH AI) ---
  const startQuiz = async () => {
    if (!isOnline) {
      showNotification("Butuh internet untuk buat soal baru!");
      return;
    }

    setIsGenerating(true);
    setUsedAI(false);

    let newQuestions = null;

    // 1. COBA MENGGUNAKAN AI
    try {
      newQuestions = await generateQuestionsWithGemini(grade, subject, qCount);
      if (newQuestions) {
        setUsedAI(true);
      }
    } catch (e) {
      console.log("AI failed, using fallback");
    }

    // 2. FALLBACK KE LOKAL JIKA AI GAGAL / NULL
    if (!newQuestions) {
      newQuestions = [];
      showNotification("AI sibuk, menggunakan Bank Soal Lokal...");
      
      for (let i = 0; i < qCount; i++) {
        let qData;
        if (subject === "Matematika") {
          qData = generateMathQuestion(grade);
        } else if (subject === "B. Inggris") {
          qData = generateEnglishQuestion(grade);
        } else if (subject === "Sains (IPAS)") {
          qData = generateScienceQuestion(grade);
        } else {
          const filtered = STATIC_POOL.filter(p => p.subject === subject);
          const rand = filtered.length > 0 ? getRandomItem(filtered) : STATIC_POOL[0];
          qData = {
              question: rand.q,
              answer: rand.a,
              options: shuffleArray([...rand.o]),
              type: subject
          };
        }
        newQuestions.push(qData);
      }
    }

    setIsGenerating(false);
    setQuestions(newQuestions);
    setScore(0);
    setCurrentIdx(0);
    setView("playing");
    setSelectedOpt(null);
    setIsCorrect(null);
  };

  const handleAnswer = (opt) => {
    if (selectedOpt) return;

    const currentQ = questions[currentIdx];
    const correct = opt === currentQ.answer;
    
    setSelectedOpt(opt);
    setIsCorrect(correct);
    if (correct) setScore(s => s + 1);

    setTimeout(() => {
      if (currentIdx < questions.length - 1) {
        setCurrentIdx(c => c + 1);
        setSelectedOpt(null);
        setIsCorrect(null);
      } else {
        finishQuiz(correct ? score + 1 : score);
      }
    }, 1500);
  };

  const finishQuiz = async (finalScore) => {
    setView("result");
    if (user && isOnline) {
      try {
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), {
          grade: grade,
          subject: subject,
          score: finalScore,
          total: questions.length,
          timestamp: serverTimestamp()
        });
      } catch (e) {
        console.error("Save error", e);
      }
    }
  };

  // --- RENDER HELPERS ---
  const renderSetup = () => (
    <div className="max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden relative">
      <div className="bg-gradient-to-r from-blue-500 to-indigo-600 p-6 text-white text-center">
        <div className="flex justify-center items-center gap-2 mb-2">
          <Globe size={32} className="text-yellow-300" />
          <Brain size={32} className="text-white" />
        </div>
        <h1 className="text-2xl font-bold">Latihan Soal SD + AI</h1>
        <p className="opacity-90 text-sm">Powered by Google Gemini</p>
      </div>

      <div className="p-6 space-y-6">
        {/* Status Koneksi */}
        <div className={`flex items-center justify-center gap-2 p-2 rounded-lg text-sm font-bold ${isOnline ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
          {isOnline ? <Wifi size={16}/> : <WifiOff size={16}/>}
          {isOnline ? "Terhubung ke Server AI" : "Offline (Generator Lokal)"}
        </div>

        {/* Form Inputs */}
        <div className={isGenerating ? "opacity-50 pointer-events-none" : ""}>
          <div className="mb-4">
            <label className="block text-sm font-bold text-gray-700 mb-2">Pilih Kelas</label>
            <div className="grid grid-cols-6 gap-2">
              {[1, 2, 3, 4, 5, 6].map((g) => (
                <button
                  key={g}
                  onClick={() => setGrade(g)}
                  className={`p-2 rounded-lg font-bold transition-all ${grade === g ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-600'}`}
                >
                  {g}
                </button>
              ))}
            </div>
          </div>

          <div className="mb-4">
            <label className="block text-sm font-bold text-gray-700 mb-2">Mata Pelajaran</label>
            <div className="grid grid-cols-2 gap-2">
              {SUBJECTS[grade].map((sub) => (
                <button
                  key={sub}
                  onClick={() => setSubject(sub)}
                  className={`p-3 rounded-xl text-xs font-bold border-2 transition-all ${subject === sub ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-transparent bg-gray-100'}`}
                >
                  {sub}
                </button>
              ))}
            </div>
          </div>

          <div className="mb-4">
            <div className="flex justify-between mb-2">
              <label className="text-sm font-bold text-gray-700">Jumlah Soal</label>
              <span className="text-blue-600 font-bold bg-blue-50 px-2 rounded">{qCount}</span>
            </div>
            <input 
              type="range" min="5" max="20" step="5"
              value={qCount} onChange={(e) => setQCount(parseInt(e.target.value))}
              className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
            />
          </div>
        </div>

        <button 
          onClick={startQuiz}
          disabled={!isOnline || isGenerating}
          className={`w-full font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 text-lg transition-all ${
            isOnline && !isGenerating
            ? 'bg-yellow-400 hover:bg-yellow-500 text-yellow-900 active:scale-95' 
            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
          }`}
        >
          {isGenerating ? (
            <><Loader2 className="animate-spin" /> Sedang Membuat Soal...</>
          ) : (
            <><Sparkles size={20} /> Generate Soal AI</>
          )}
        </button>
      </div>
    </div>
  );

  const renderPlaying = () => {
    const q = questions[currentIdx];
    return (
      <div className="max-w-xl w-full">
        <div className="flex justify-between items-center mb-6 text-white">
          <div className="bg-white/20 backdrop-blur px-4 py-2 rounded-full font-bold text-sm flex items-center gap-2">
            {subject} â€¢ Kelas {grade}
            {usedAI && <Sparkles size={14} className="text-yellow-300" />}
          </div>
          <div className="bg-white/20 backdrop-blur px-4 py-2 rounded-full font-bold flex items-center gap-2">
            <Star size={18} className="text-yellow-300 fill-current" /> {score}
          </div>
        </div>

        <div className="bg-white rounded-3xl shadow-2xl p-8 text-center relative overflow-hidden min-h-[400px] flex flex-col justify-center">
          <span className="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">
            Soal {currentIdx + 1} / {questions.length}
          </span>
          <h2 className="text-xl md:text-3xl font-bold text-gray-800 mb-8 leading-snug">
            {q.question}
          </h2>
          <div className="grid grid-cols-1 gap-3">
            {q.options.map((opt, idx) => {
              let btnClass = "bg-gray-50 border-2 border-gray-100 text-gray-700 hover:border-blue-300";
              if (selectedOpt) {
                if (opt === q.answer) btnClass = "bg-green-100 border-green-500 text-green-800 font-bold";
                else if (opt === selectedOpt) btnClass = "bg-red-100 border-red-500 text-red-800";
                else btnClass = "opacity-50 bg-gray-50";
              }
              return (
                <button
                  key={idx} disabled={!!selectedOpt}
                  onClick={() => handleAnswer(opt)}
                  className={`p-4 rounded-xl text-lg transition-all flex justify-between items-center ${btnClass}`}
                >
                  {opt}
                  {selectedOpt && opt === q.answer && <CheckCircle size={20} className="text-green-600" />}
                  {selectedOpt && opt === selectedOpt && opt !== q.answer && <XCircle size={20} className="text-red-500" />}
                </button>
              )
            })}
          </div>
        </div>
        {usedAI && (
          <div className="text-center mt-4 text-white/70 text-sm flex justify-center items-center gap-1">
            <Sparkles size={14} /> Soal ini dibuat oleh AI
          </div>
        )}
      </div>
    );
  };

  const renderResult = () => {
    const percentage = Math.round((score / questions.length) * 100);
    return (
      <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 text-center">
        <div className="mb-6 flex justify-center">
          {percentage >= 80 ? <Trophy size={80} className="text-yellow-400"/> : <Leaf size={80} className="text-green-400"/>}
        </div>
        <h2 className="text-3xl font-black text-gray-800 mb-2">Selesai!</h2>
        <p className="text-gray-500 mb-6">Skor akhir kamu:</p>
        <div className="text-6xl font-black text-blue-600 mb-8">{percentage}</div>
        <button onClick={() => setView("setup")} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center gap-2">
          <RefreshCcw /> Main Lagi
        </button>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-cyan-500 to-blue-600 flex flex-col items-center justify-center p-4 font-sans relative">
      {/* Toast Notification */}
      {notification && (
        <div className="fixed top-6 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-2 animate-bounce">
          <AlertCircle size={20} />
          <span className="font-bold">{notification}</span>
        </div>
      )}

      {view === "setup" && renderSetup()}
      {view === "playing" && renderPlaying()}
      {view === "result" && renderResult()}
      <div className="mt-8 text-white/50 text-xs">Connected App ID: {appId}</div>
    </div>
  );
}
